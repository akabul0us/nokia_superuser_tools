#!/bin/sh
set -e
if [ ! -d /configs/dropbear ]; then
    mkdir -p /configs/dropbear
fi
if [ ! -e /configs/bin/dropbearmulti ]; then
    echo "Dropbearmulti not installed!"
    exit 1
fi
if [ ! -h /configs/bin/dropbear ]; then
    echo "Create dropbear symlinks first!"
    exit 1
fi
if [ ! -e /configs/dropbear/authorized_keys ]; then
    touch /configs/dropbear/authorized_keys
    /configs/bin/dropbearkey -t ed25519 -f /configs/dropbear/id_ed25519
    cat /configs/dropbear/id_ed25519.pub > /configs/dropbear/authorized_keys
    /configs/bin/dropbearconvert dropbear openssh /configs/dropbear/id_ed25519 /configs/dropbear/id_ed25519_openssh
    chmod 600 /configs/dropbear/id_ed25519
    chmod 600 /configs/dropbear/id_ed25519_openssh
fi
echo "Starting on port 2244..."
/configs/bin/dropbear -r /configs/dropbear/dropbear_ed25519_host_key -D /configs/dropbear -R -a -p 2244 -p 22 -P /var/run/dropbear1.pid -K 300 -I 0
