#script to run on an exploited device
#!/bin/sh
if [ -z "$1" ]; then
    read -p "Path to tarball: " tarball
else
    tarball="$1"
fi
if [ ! -f "$tarball" ]; then
    echo "No tarball found with that name/at that path"
    exit 1
fi
echo "Extracting..."
tar -C /var xzvf $tarball
echo "Moving bin to /configs and chungus to /logs"
cd /var
if [ ! -d /configs/bin ]; then
    mv bin /configs/
else
    echo "/configs/bin already exists"
fi
if [ ! -d /logs/chungus ]; then
    mv chungus /logs/
else
    echo "/logs/chungus already exists"
fi
mv chungus /logs/
echo "Setting up symlinks"
sh /configs/bin/busybox-install-applets.sh
sh /configs/bin/dropbear-symlinks.sh
export PATH=/configs/bin:$PATH
echo "Starting threads with update scripts"
update-profile &
update-iptables &
echo "Running fix scripts"
fix-mounts
fix-ssh
echo "Running new scripts - follow their instructions"
new-seconf &
pkill /sbin/sec_monitor && /sbin/sec_monitor /usr/etc/se.conf &
guardianpid="$(ps | grep -m1 "/usr/exe/data_guardian.sh" | grep -oE -m1 "[0-9]{4,6}" | head -n 1)"
new-guardian &
kill $guardianpid && /usr/exe/data_guardian.sh 
echo "Chungusing"
chungus-web
echo "Done"
