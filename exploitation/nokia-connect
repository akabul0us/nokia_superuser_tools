#!/bin/bash
show_help() {
echo 'Usage: nokia-connect [IP ADDRESS] [port]'
echo 'If no IP address is given, the default is 192.168.1.254'
echo "If no port is given, the default is 22\n"
echo 'This script requires sshpass to be installed and uses'
echo 'a file located at $HOME/ontuser to store default password "admin".'
}
if [ -z "$1" ]; then
    ip_connect="192.168.1.254"
else
    ip_connect="$1"
fi
if [[ "$ip_connect" == "-h" || "$1" == "--help" ]]; then
  show_help
  exit 0
fi
if [ -z "$2" ]; then
    port=22
else
    port="$2"
fi
#check if the IP is a valid string
echo "$ip_connect" | grep -oE "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)" > /dev/null
ip_result="$?"
if [ "$ip_result" == 1 ]; then
    echo "$ip_connect is not a valid IP address"
    exit 1
fi
#check if port is a valid number
if [ "$port" -ge 1 ] && [ "$port" -le 65535 ]; then
    echo "Connecting to $ip_connect on port $port"
else
    echo "$port is not a valid port number"
    exit 1
fi
#check for credentials file, create if not found
if [ ! -f $HOME/ontuser ]; then
    echo "Creating credentials file at $HOME/ontuser"
    echo "admin" > $HOME/ontuser
fi
if [ -x "$(which sshpass)" ]; then
    if [ -x "$(which ssh)" ]; then        
        sshpass -f $HOME/ontuser ssh -oStrictHostKeyChecking=no -oKexAlgorithms=+diffie-hellman-group1-sha1 -oHostKeyAlgorithms=+ssh-rsa ONTUSER@$ip_connect -p $port
    else
        echo "SSH not found"
        exit 1
    fi
else
    echo "SSHpass not found: login will require password entry"
    ssh -oStrictHostKeyChecking=no -oKexAlgorithms=+diffie-hellman-group1-sha1 -oHostKeyAlgorithms=+ssh-rsa ONTUSER@$ip_connect -p $port
fi
