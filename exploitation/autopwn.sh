#!/bin/bash
red='\033[0;31m'
green='\033[0;32m'
clear='\033[0m'
UNAME="$(uname -o)"
temp_dir="$HOME/.tmp"
if [ ! -d "$temp_dir" ]; then
     mkdir $temp_dir
fi
if [ "$YOU_KNOW_WHAT" == "THIS_IS_KALI_LINUX_NETHUNTER_FROM_JAVA_BINKY" ]; then
     printf "${green}"
     echo "Nethunter detected as host"
     printf "${clear}"
     config_dir=/root/nokia-cfgs
     download_dir=/sdcard/Download
elif [ ! -z "$TERMUX_APP_PID" ]; then
     printf "${green}"
     echo "Termux detected as host"
     printf "${clear}"
     config_dir=/data/data/com.termux/files/home/nokia-cfgs
     download_dir=/storage/emulated/0/Download
elif [ "$UNAME" == "GNU/Linux" ]; then
     printf "${green}"
     echo "GNU/Linux detected as host"
     printf "${clear}"
     config_dir=$HOME/nokia-cfgs
     download_dir=$HOME/Downloads
fi
if [ ! -d "$config_dir" ]; then
   printf "${red}No config directory found.\n${clear}"
   read -p "Create one at $config_dir? (y/n)" yorn
   while true; do
        case $yorn in
          [Yy] ) mkdir -p $config_dir
             break;;
          [Nn] ) echo "Quitting..."
             exit 1;;
          * )printf "${red}\n"
             echo "Invalid response!"
             printf "${clear}" ;;
        esac
   done
fi
if [ -z "$1" ]; then
    printf "${green}"
    read -p "IP address of downloaded config.cfg file: " IP
    printf "${clear}"
else
    IP="$1"
fi
printf "${green}"
echo "Looking for a file named config.cfg in $download_dir..."
printf "${clear}"
if [ ! -e "$download_dir/config.cfg" ]; then
    printf "${red} File not found! ${clear}\n"
    read -p "Please enter the absolute path for the file: " filepath
    printf "\n"
else
    filepath="$download_dir/config.cfg"
fi
printf "${green}Moving config.cfg to $config_dir/$IP.cfg...${clear}\n"
mv $filepath $config_dir/$IP.cfg
cd $config_dir
printf "${green}Unpacking...${clear}\n"
nokia-use-ip-cfg -u $config_dir/$IP.cfg | tee $temp_dir/repack-code.txt
printf "${green}Editing XML file...${clear}\n"
nokia-xml-editor $config_dir/$IP.xml
printf "${green}Repacking...${clear}\n"
repack_code="$(tail -n 2 $temp_dir/repack-code.txt | head -n 1)"
$repack_code
printf "${green}Copying repacked config to $download_dir/dropbear...${clear}\n\n"
cp $config_dir/$IP-dropbear $download_dir/dropbear
printf "${green}Now upload the repacked file and import${clear}\n"
rm $temp_dir/repack-code.txt
